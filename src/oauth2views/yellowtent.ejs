(function () {
'use strict';

if (!window.yellowtent) {
    window.yellowtent = {};
}

var yellowtent = window.yellowtent;
var server = '<%= origin %>';

// handle the oauth flow
yellowtent.oauth = {};
yellowtent.endOAuth = endOAuth;
yellowtent.setupButton = setupButton;

function startOAuth(button, resultCallback) {
    var clientId = button.getAttribute('data-clientid');
    var callback = button.getAttribute('data-callback');

    yellowtent.oauth = {};
    yellowtent.oauth.button = button;
    yellowtent.oauth.clientId = clientId;
    yellowtent.oauth.callback = resultCallback || window[callback];
    yellowtent.oauth.redirectURI = button.getAttribute('data-redirect-uri') || '';

    console.log('Staring OAuth for client ' + clientId + ' and callback ' + callback + ' with redirectURI ' + yellowtent.oauth.redirectURI);

    var width = 400;
    var height = 600;
    var left = screen.width / 2.0 - width / 2.0;
    var top = screen.height / 2.0 - height / 2.0;
    var oauthURI = server + '/api/v1/oauth/dialog/authorize?response_type=code&client_id=' + clientId + '&redirect_uri=' + server + yellowtent.oauth.redirectURI;

    window.open(oauthURI, 'Yellowtent', 'width=400, height=600, left=' + left + ', top=' + top);
}

function endOAuth(result) {
    if (!yellowtent.oauth) {
        return;
    }

    if (!result || !result.authCode) {
        console.error('OAuth result does not contain an authCode.');
        return;
    }

    yellowtent.oauth.callback.apply(null, [result.authCode]);
}

function setupButton(button, resultCallback) {
    button.innerHTML = '<input class="btn btn-green btn-block" type="button" value="Sign in with Yellowtent"/>';
    button.onclick = function () {
        startOAuth(button, resultCallback);
    };
}

window.addEventListener('load', function () {
    console.log('Yellowtent init');

    function clickEventHandler(event) {
        startOAuth(event.target.parentElement);
    }

    var signIns = window.document.getElementsByClassName('yellowtent-signin');
    for (var i = 0; i < signIns.length; ++i) {
        var button = signIns[0];

        button.innerHTML = '<input class="btn btn-green btn-block" type="button" value="Sign in with Yellowtent"/>';
        button.onclick = clickEventHandler;
    }

}, false );

window.addEventListener('message', function (event) {
    console.log('Yellowtent message received.', event.data);

    if (event.origin !== server) {
        console.log('Ignore message from unknown source.');
        return;
    }

    var result = null;

    try {
        result = JSON.parse(event.data);
    } catch (e) {
        console.error('Unable to parse message payload.', e);
        return;
    }

    endOAuth(result);
}, false );

})();
