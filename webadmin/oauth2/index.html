<html>
<head>
    <title> Accounts </title>

    <style>

    body {
        background-color: lightgray;
    }

    iframe {
        background-color: lightsteelblue;
        border: 0;
        width: 300px;
        height: 300px;
    }

    </style>

    <script src="javascripts/superagent.js"></script>

<script>

var frame, startBtn, tokenBtn, authCode, oauthResult, accessToken;
var isReady = false;
var accountsServer = 'https://localhost/auth';
var redirectServer = 'https://localhost';

function setAuthCode(code) {
    if (!isReady) return;

    console.log('---- setAuthCode()', code);

    if (code) {
        tokenBtn.style.display = 'block';
        authCode = code;
        oauthResult.innerHTML = 'Auth Code ' + authCode;
    } else {
        oauthResult.innerHTML = 'Access Denied';
    }
}

function init() {
    startBtn = document.getElementById('startButton');
    tokenBtn = document.getElementById('tokenButton');
    frame = document.getElementById('frame');
    oauthResult = document.getElementById('oauthResult');

    startBtn.onclick = function () {
        frame.src = accountsServer + '/api/v1/oauth/dialog/authorize?response_type=code&client_id=abc123&redirect_uri=' + redirectServer + '/oauth2/oauth_callback.html';
        frame.style.display = 'block';
    };

    // Rough example OAuth flow initiation for only client side bearer token (aka accessToken)
    // startBtn.onclick = function () {
    //     frame.src = accountsServer + '/api/v1/oauth/dialog/authorize?response_type=token&client_id=abc123&redirect_uri=' + redirectServer + '/oauth2/oauth_callback.html';
    //     frame.style.display = 'block';
    // };

    tokenBtn.onclick = function () {
        superagent.post(accountsServer + '/api/v1/oauth/token?response_type=token&client_id=abc123')
        .send({
            grant_type: 'authorization_code',
            code: authCode,
            redirect_uri: redirectServer + '/oauth2/oauth_callback.html',
            client_id: 'abc123',
            client_secret: 'testClientSecret'
        })
        .end(function (error, result) {
            if (error) {
                alert('Exchange failed, see console.');
                console.error(error);
                return;
            }

            tokenBtn.style.display = 'none';
            accessToken = result.body.access_token
            oauthResult.innerHTML = 'Access Token ' + accessToken;
            console.log(result.body);
        });
    };

    isReady = true;
}

</script>

</head>

<body onload="init()">

<hr/>
OAuth based login: <button id="startButton">Go for it</button>
<small>Development owner credentials: admin:test</small>

<div id="oauthResult"></div>
<button id="tokenButton" style="display: none"/>Exchange code for token</button>
<iframe id="frame" style="display: none"></iframe>

</body>
</html>
