<html>
<head>
    <title> Accounts </title>

    <link href="../css/index.css" rel="stylesheet" media="screen">

    <style>

    iframe {
        width: 400px;
        height: 600px;
    }

    </style>

    <script src="javascripts/superagent.js"></script>
    <script src="/api/v1/oauth/cloudron.js"></script>

<script>

'use strict';

var tokenBtn, authCode, oauthResult, accessToken;
var isReady = false;
var clientId = 'cid-webadmin';
var clientSecret = 'unused';

function setAuthCode(code) {
    if (!isReady) return;

    if (code) {
        tokenBtn.style.display = 'block';
        authCode = code;
        oauthResult.innerHTML = 'Auth Code ' + authCode;
    } else {
        oauthResult.innerHTML = 'Access Denied';
    }
}

function init() {
    tokenBtn = document.getElementById('tokenButton');
    oauthResult = document.getElementById('oauthResult');

    tokenBtn.onclick = function () {
        superagent.post(window.location.origin + '/api/v1/oauth/token?response_type=token&client_id=' + clientId)
        .send({
            grant_type: 'authorization_code',
            code: authCode,
            redirect_uri: window.location.origin + '/oauth2/oauth_callback.html',
            client_id: clientId,
            client_secret: clientSecret
        })
        .end(function (error, result) {
            if (error) {
                alert('Exchange failed, see console.');
                console.error(error);
                return;
            }

            tokenBtn.style.display = 'none';
            accessToken = result.body.access_token
            oauthResult.innerHTML = 'Access Token ' + accessToken;
            console.log(result.body);
        });
    };

    isReady = true;
}

</script>

</head>

<body onload="init()">

OAuth based login: <div class="cloudron-signin" data-callback="setAuthCode" data-clientid="cid-webadmin" data-requestscopes="*"></div>

<div id="oauthResult"></div>
<button id="tokenButton" style="display: none"/>Exchange code for token</button>

</body>
</html>
