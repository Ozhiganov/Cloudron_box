(function () {
'use strict';

if (!window.cloudron) {
    window.cloudron = {};
}

var cloudron = window.cloudron;
var server = '<%= adminOrigin %>';

// handle the oauth flow
cloudron.oauth = {};
cloudron.endOAuth = endOAuth;
cloudron.setupButton = setupButton;

function startOAuth(button, resultCallback) {
    var clientId = button.getAttribute('data-clientid');
    var callback = button.getAttribute('data-callback');

    cloudron.oauth = {};
    cloudron.oauth.button = button;
    cloudron.oauth.clientId = clientId;
    cloudron.oauth.callback = resultCallback || window[callback];
    cloudron.oauth.redirectURI = button.getAttribute('data-redirect-uri') || '';

    var width = 400;
    var height = 600;
    var left = screen.width / 2.0 - width / 2.0;
    var top = screen.height / 2.0 - height / 2.0;
    var oauthURI = server + '/api/v1/oauth/dialog/authorize?response_type=code&client_id=' + clientId + '&redirect_uri=' + server + cloudron.oauth.redirectURI;

    window.open(oauthURI, 'cloudron', 'width=400, height=600, left=' + left + ', top=' + top);
}

function endOAuth(result) {
    if (!cloudron.oauth) {
        return;
    }

    if (!result || !result.authCode) {
        console.error('OAuth result does not contain an authCode.');
        return;
    }

    cloudron.oauth.callback.apply(null, [result.authCode]);
}

function setupButton(button, resultCallback) {
    button.innerHTML = '<input class="btn btn-green btn-block" type="button" value="Sign in with your cloudron"/>';
    button.onclick = function () {
        startOAuth(button, resultCallback);
    };
}

window.addEventListener('load', function () {
    function clickEventHandler(event) {
        startOAuth(event.target.parentElement);
    }

    var signIns = window.document.getElementsByClassName('cloudron-signin');
    for (var i = 0; i < signIns.length; ++i) {
        var button = signIns[0];

        button.innerHTML = '<input class="btn btn-green btn-block" type="button" value="Sign in with your cloudron"/>';
        button.onclick = clickEventHandler;
    }

}, false );

window.addEventListener('message', function (event) {
    // ignore messages from unknown origins
    if (event.origin !== server) return;

    var result = null;

    try {
        result = JSON.parse(event.data);
    } catch (e) {
        console.error('Unable to parse message payload.', e);
        return;
    }

    endOAuth(result);
}, false );

})();
